{% extends "base.html" %}
{% block title %}{{ away_name }} @ {{ home_name }} — FIV — Viperball Stats{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb"><div class="container wide">
  <a href="/stats/">Home</a><span class="sep">/</span><a href="/stats/international/">International</a><span class="sep">/</span>Match
</div></div>
{% endblock %}

{% block content %}

<div class="box-score-header">
  <div class="box-team">
    <div class="name"><a href="/stats/international/team/{{ away_code }}">{{ away_name }}</a></div>
    <div class="record">{{ away_code }}</div>
    <div class="box-score-final {% if match.get('away_score', 0) > match.get('home_score', 0) %}score-win{% else %}score-loss{% endif %}">{{ match.get('away_score', 0) }}</div>
  </div>
  <div class="box-score-vs">
    <div>FINAL</div>
    <div>{{ match.get('competition', '') | replace('_', ' ') | title }}</div>
    <div style="font-size:10px;color:var(--fg-dim)">{{ match.get('stage', '') | replace('_', ' ') | title }}</div>
  </div>
  <div class="box-team">
    <div class="name"><a href="/stats/international/team/{{ home_code }}">{{ home_name }}</a></div>
    <div class="record">{{ home_code }}</div>
    <div class="box-score-final {% if match.get('home_score', 0) > match.get('away_score', 0) %}score-win{% else %}score-loss{% endif %}">{{ match.get('home_score', 0) }}</div>
  </div>
</div>

{% if gr %}
{% set stats = gr.get('stats', {}) %}
{% set hs = stats.get('home', {}) %}
{% set as_ = stats.get('away', {}) %}
{% set hm = hs.get('viperball_metrics', {}) %}
{% set am = as_.get('viperball_metrics', {}) %}

{# ── Weather ── #}
{% set weather = gr.get('weather', '') %}
{% if weather and weather|lower not in ('clear', 'none', '') %}
<div style="margin:10px 0;">
  <span style="color:var(--cyan);">Weather:</span>
  <span style="color:var(--fg-bright);">{{ weather | replace('_', ' ') | title }}</span>
</div>
{% endif %}

{# ── Game Ratings ── #}
{% if hm or am %}
<h2>Game Ratings</h2>
<div class="grid-4" style="margin-bottom:16px;">
  {% for label, key, src, fmt, elite_thresh, good_thresh in [
    ('Team Rating', 'team_rating', 'vm', '%.1f', 75, 55),
    ('PPD', 'ppd', 'vm', '%.2f', 5.0, 3.5),
    ('EPA', 'epa', 'ts', '%.1f', 5, 0),
    ('Explosive Plays', 'explosive_plays', 'vm', '%d', 8, 5),
  ] %}
  <div class="metric">
    <div class="label">{{ label }}</div>
    <div class="value" style="font-size:11px;">
      {% if src == 'ts' %}{% set av = as_.get(key) %}{% set hv = hs.get(key) %}{% else %}{% set av = am.get(key) %}{% set hv = hm.get(key) %}{% endif %}
      <span class="{% if av is not none and av >= elite_thresh %}stat-elite{% elif av is not none and av >= good_thresh %}stat-good{% endif %}">{{ fmt|format(av) if av is not none else '—' }}</span>
      <span style="color:var(--fg-dim)">&nbsp;/&nbsp;</span>
      <span class="{% if hv is not none and hv >= elite_thresh %}stat-elite{% elif hv is not none and hv >= good_thresh %}stat-good{% endif %}">{{ fmt|format(hv) if hv is not none else '—' }}</span>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

{# ── Team Stats ── #}
{% macro stat_row(label, key, fmt='d', suffix='') %}
{% if as_.get(key) is not none or hs.get(key) is not none %}
<tr>
  <td class="num">{% if fmt == 'f1' %}{{ '%.1f'|format(as_.get(key, 0)) }}{{ suffix }}{% elif fmt == 'f2' %}{{ '%.2f'|format(as_.get(key, 0)) }}{{ suffix }}{% else %}{{ as_.get(key, 0) }}{{ suffix }}{% endif %}</td>
  <td>{{ label }}</td>
  <td class="num">{% if fmt == 'f1' %}{{ '%.1f'|format(hs.get(key, 0)) }}{{ suffix }}{% elif fmt == 'f2' %}{{ '%.2f'|format(hs.get(key, 0)) }}{{ suffix }}{% else %}{{ hs.get(key, 0) }}{{ suffix }}{% endif %}</td>
</tr>
{% endif %}
{% endmacro %}

{% macro section_header(title) %}
<tr style="border-top:2px solid var(--border)"><td colspan="3" style="color:var(--accent);font-weight:bold;font-size:11px;letter-spacing:1px;padding-top:8px">{{ title }}</td></tr>
{% endmacro %}

{% if hs or as_ %}
<h2>Team Stats</h2>
<table>
  <thead><tr><th class="num">{{ away_name[:20] }}</th><th>Stat</th><th class="num">{{ home_name[:20] }}</th></tr></thead>
  <tbody>
  {{ section_header('OFFENSE') }}
  {{ stat_row('Total Yards', 'total_yards') }}
  {{ stat_row('Total Plays', 'total_plays') }}
  {{ stat_row('Yards / Play', 'yards_per_play', 'f2') }}
  {{ stat_row('Touchdowns', 'touchdowns') }}
  {{ stat_row('Viper Efficiency', 'viper_efficiency', 'f2') }}

  {% if as_.get('rushing_carries') is not none or hs.get('rushing_carries') is not none %}
  {{ section_header('RUSHING') }}
  {{ stat_row('Carries', 'rushing_carries') }}
  {{ stat_row('Rushing Yards', 'rushing_yards') }}
  {{ stat_row('Rushing TDs', 'rushing_touchdowns') }}
  {% endif %}

  {% if as_.get('kick_passes_attempted') or hs.get('kick_passes_attempted') %}
  {{ section_header('KICK-PASS') }}
  <tr>
    <td class="num">{{ as_.get('kick_passes_completed', 0) }}/{{ as_.get('kick_passes_attempted', 0) }}</td>
    <td>Completions / Attempts</td>
    <td class="num">{{ hs.get('kick_passes_completed', 0) }}/{{ hs.get('kick_passes_attempted', 0) }}</td>
  </tr>
  {{ stat_row('Kick-Pass Yards', 'kick_pass_yards') }}
  {{ stat_row('Kick-Pass TDs', 'kick_pass_tds') }}
  {{ stat_row('Interceptions Thrown', 'kick_pass_interceptions') }}
  {% endif %}

  {% if as_.get('lateral_chains') or hs.get('lateral_chains') %}
  {{ section_header('LATERAL GAME') }}
  {{ stat_row('Lateral Chains', 'lateral_chains') }}
  {{ stat_row('Lateral Yards', 'lateral_yards') }}
  {% endif %}

  {% if as_.get('drop_kicks_attempted') or hs.get('drop_kicks_attempted') or as_.get('place_kicks_attempted') or hs.get('place_kicks_attempted') %}
  {{ section_header('KICKING') }}
  {% if as_.get('drop_kicks_attempted') or hs.get('drop_kicks_attempted') %}
  <tr>
    <td class="num">{{ as_.get('drop_kicks_made', 0) }}/{{ as_.get('drop_kicks_attempted', 0) }}</td>
    <td>Drop Kicks (Made/Att)</td>
    <td class="num">{{ hs.get('drop_kicks_made', 0) }}/{{ hs.get('drop_kicks_attempted', 0) }}</td>
  </tr>
  {% endif %}
  {% if as_.get('place_kicks_attempted') or hs.get('place_kicks_attempted') %}
  <tr>
    <td class="num">{{ as_.get('place_kicks_made', 0) }}/{{ as_.get('place_kicks_attempted', 0) }}</td>
    <td>Place Kicks (Made/Att)</td>
    <td class="num">{{ hs.get('place_kicks_made', 0) }}/{{ hs.get('place_kicks_attempted', 0) }}</td>
  </tr>
  {% endif %}
  {% endif %}

  {{ section_header('TURNOVERS &amp; DISCIPLINE') }}
  {{ stat_row('Fumbles Lost', 'fumbles_lost') }}
  {{ stat_row('Turnovers on Downs', 'turnovers_on_downs') }}
  {% if as_.get('penalties') is not none or hs.get('penalties') is not none %}
  <tr>
    <td class="num">{{ as_.get('penalties', 0) }} ({{ as_.get('penalty_yards', 0) }} yds)</td>
    <td>Penalties (Yards)</td>
    <td class="num">{{ hs.get('penalties', 0) }} ({{ hs.get('penalty_yards', 0) }} yds)</td>
  </tr>
  {% endif %}

  {% if as_.get('delta_yards') is not none or hs.get('delta_yards') is not none %}
  {{ section_header('DELTA SYSTEM') }}
  <tr>
    <td class="num {% if as_.get('delta_yards', 0) > 0 %}stat-good{% elif as_.get('delta_yards', 0) < 0 %}stat-bad{% endif %}">{{ as_.get('delta_yards', 0) }}</td>
    <td>Delta Yards</td>
    <td class="num {% if hs.get('delta_yards', 0) > 0 %}stat-good{% elif hs.get('delta_yards', 0) < 0 %}stat-bad{% endif %}">{{ hs.get('delta_yards', 0) }}</td>
  </tr>
  {% endif %}

  {% if as_.get('bonus_possessions', 0) > 0 or hs.get('bonus_possessions', 0) > 0 %}
  {{ section_header('BONUS POSSESSIONS') }}
  {{ stat_row('Bonus Possessions', 'bonus_possessions') }}
  {{ stat_row('Bonus Scores', 'bonus_possession_scores') }}
  {% endif %}

  </tbody>
</table>
{% endif %}

{# ── Player Stats ── #}
{% set ps = gr.get('player_stats', {}) %}
{% for side, team_label, team_code in [('away', away_name, away_code), ('home', home_name, home_code)] %}
{% set side_players = ps.get(side, []) %}
{% if side_players %}

{% set off_players = [] %}
{% for p in side_players if p.get('touches', 0) > 0 or p.get('yards', 0) > 0 or p.get('kick_passes_thrown', 0) > 0 %}
{% if off_players.append(p) %}{% endif %}
{% endfor %}
{% if off_players %}
<h2>{{ team_label }} — Offense</h2>
<div style="overflow-x:auto;">
<table>
  <thead><tr><th>Tag</th><th>Name</th><th class="num">TCH</th><th class="num">YDS</th><th class="num">RUSH</th><th class="num">KP</th><th class="num">TD</th><th class="num">FUM</th><th class="num">LAT</th><th class="num">WPA</th></tr></thead>
  <tbody>
  {% for p in off_players|sort(attribute='yards', reverse=true) %}
  <tr>
    <td><span class="tag tag-pos">{{ p.get('tag', '??') }}</span></td>
    <td><a href="/stats/international/team/{{ team_code }}/player/{{ p.get('name', '') }}">{{ p.get('name', '?') }}</a></td>
    <td class="num">{{ p.get('touches', 0) }}</td>
    <td class="num {% if p.get('yards', 0) >= 100 %}stat-elite{% elif p.get('yards', 0) >= 50 %}stat-good{% endif %}">{{ p.get('yards', 0) }}</td>
    <td class="num">{{ p.get('rushing_yards', 0) }}</td>
    <td class="num">{% if p.get('kick_pass_receptions', 0) > 0 %}{{ p.get('kick_pass_yards', 0) }}{% elif p.get('kick_passes_thrown', 0) > 0 %}{{ p.get('kick_pass_yards', 0) }} <span style="color:var(--fg-dim);font-size:10px">({{ p.kick_passes_completed }}/{{ p.kick_passes_thrown }})</span>{% else %}0{% endif %}</td>
    <td class="num {% if p.get('tds', 0) > 0 %}stat-elite{% endif %}">{{ p.get('tds', 0) }}</td>
    <td class="num {% if p.get('fumbles', 0) > 0 %}stat-bad{% endif %}">{{ p.get('fumbles', 0) }}</td>
    <td class="num">{{ p.get('laterals_thrown', 0) }}</td>
    <td class="num {% if p.get('wpa', 0) > 3 %}stat-good{% elif p.get('wpa', 0) < -3 %}stat-bad{% endif %}">{{ '%.1f'|format(p.get('wpa', 0)) }}</td>
  </tr>
  {% endfor %}
  </tbody>
</table>
</div>
{% endif %}

{% set def_players = [] %}
{% for p in side_players if p.get('tackles', 0) > 0 or p.get('sacks', 0) > 0 or p.get('tfl', 0) > 0 %}
{% if def_players.append(p) %}{% endif %}
{% endfor %}
{% if def_players %}
<h3 style="margin-top:12px;">{{ team_label }} — Defense</h3>
<div style="overflow-x:auto;">
<table>
  <thead><tr><th>Tag</th><th>Name</th><th class="num">TKL</th><th class="num">TFL</th><th class="num">SCK</th><th class="num">HUR</th><th class="num">INT</th><th class="num">WPA</th></tr></thead>
  <tbody>
  {% for p in def_players|sort(attribute='tackles', reverse=true) %}
  <tr>
    <td><span class="tag tag-pos">{{ p.get('tag', '??') }}</span></td>
    <td><a href="/stats/international/team/{{ team_code }}/player/{{ p.get('name', '') }}">{{ p.get('name', '?') }}</a></td>
    <td class="num {% if p.get('tackles', 0) >= 8 %}stat-elite{% elif p.get('tackles', 0) >= 5 %}stat-good{% endif %}">{{ p.get('tackles', 0) }}</td>
    <td class="num {% if p.get('tfl', 0) > 0 %}stat-good{% endif %}">{{ p.get('tfl', 0) }}</td>
    <td class="num {% if p.get('sacks', 0) > 0 %}stat-elite{% endif %}">{{ p.get('sacks', 0) }}</td>
    <td class="num">{{ p.get('hurries', 0) }}</td>
    <td class="num {% if p.get('kick_pass_ints', 0) > 0 %}stat-elite{% endif %}">{{ p.get('kick_pass_ints', 0) }}</td>
    <td class="num {% if p.get('wpa', 0) > 3 %}stat-good{% elif p.get('wpa', 0) < -3 %}stat-bad{% endif %}">{{ '%.1f'|format(p.get('wpa', 0)) }}</td>
  </tr>
  {% endfor %}
  </tbody>
</table>
</div>
{% endif %}

{% endif %}
{% endfor %}

{# ── Drive Summary ── #}
{% set drives = gr.get('drive_summary', []) %}
{% if drives %}
<h2>Drive Summary</h2>
<table>
  <thead><tr><th class="num">#</th><th class="num">Qtr</th><th>Team</th><th class="num">Start</th><th class="num">Plays</th><th class="num">Yards</th><th>Result</th></tr></thead>
  <tbody>
  {% for d in drives %}
  {% set is_score = d.result in ('touchdown', 'successful_kick', 'punt_return_td', 'int_return_td', 'missed_dk_return_td', 'safety') if d.result else false %}
  <tr>
    <td class="num rank">{{ loop.index }}</td>
    <td class="num">Q{{ d.quarter }}</td>
    <td>{% if d.team == 'home' %}{{ home_name[:20] }}{% else %}{{ away_name[:20] }}{% endif %}</td>
    <td class="num">{{ d.start_yard_line }}</td>
    <td class="num">{{ d.plays }}</td>
    <td class="num {% if d.yards >= 40 %}stat-good{% endif %}">{{ d.yards }}</td>
    <td><span class="{% if is_score %}stat-elite{% elif d.result == 'punt' %}{% else %}stat-bad{% endif %}">{{ d.result | replace('_', ' ') | title if d.result else '—' }}</span></td>
  </tr>
  {% endfor %}
  </tbody>
</table>
{% endif %}

{# ── Play-by-Play ── #}
{% set pbp = gr.get('play_by_play', []) %}
{% if pbp %}
<h2>Play-by-Play ({{ pbp|length }} plays)</h2>
{% set quarters = [] %}
{% for p in pbp %}{% if p.quarter not in quarters %}{% if quarters.append(p.quarter) %}{% endif %}{% endif %}{% endfor %}
<div style="margin-bottom:8px;font-size:11px;">
  <strong>Quarter:</strong>
  <a href="#" onclick="document.querySelectorAll('.pbp-row').forEach(r=>r.style.display='');return false;" style="color:var(--accent)">All</a>
  {% for q in quarters|sort %}
  &middot; <a href="#" onclick="document.querySelectorAll('.pbp-row').forEach(r=>r.style.display=r.dataset.q=='{{ q }}'?'':'none');return false;">Q{{ q }}</a>
  {% endfor %}
</div>
<table>
  <thead><tr><th class="num">Q</th><th class="num">Time</th><th>Poss</th><th class="num">FP</th><th>Down</th><th>Play</th><th class="num">YDS</th><th class="num">EPA</th><th>Description</th></tr></thead>
  <tbody>
  {% for p in pbp %}
  {% set is_score = p.result in ('touchdown', 'successful_kick', 'punt_return_td', 'int_return_td', 'missed_dk_return_td') if p.result else false %}
  {% set is_turnover = p.result in ('kick_pass_intercepted', 'lateral_intercepted', 'fumble') if p.result else false %}
  <tr class="pbp-row" data-q="{{ p.quarter }}" {% if is_score %}style="background:#1a1a00"{% elif is_turnover %}style="background:#1a0000"{% endif %}>
    <td class="num">{{ p.quarter }}</td>
    <td class="num" style="font-variant-numeric:tabular-nums">{{ '%d:%02d'|format(p.time_remaining // 60, p.time_remaining % 60) if p.time_remaining is defined and p.time_remaining is not none else '—' }}</td>
    <td>{% if p.possession == 'home' %}{{ home_name[:15] }}{% else %}{{ away_name[:15] }}{% endif %}</td>
    <td class="num">{{ p.field_position if p.field_position is defined else '—' }}</td>
    <td>{% if p.down and p.yards_to_go %}{{ p.down }}&amp;{{ p.yards_to_go }}{% else %}&mdash;{% endif %}</td>
    <td>
      {% if is_score %}<span class="tag" style="border-color:var(--yellow);color:var(--yellow)">{{ p.play_family | default(p.play_type, true) | replace('_',' ') | upper }}</span>
      {% elif is_turnover %}<span class="tag" style="border-color:var(--red);color:var(--red)">{{ p.result | replace('_',' ') | upper }}</span>
      {% else %}<span style="color:var(--fg-dim)">{{ p.play_family | default(p.play_type, true) | replace('_',' ') }}</span>{% endif %}
    </td>
    <td class="num {% if p.yards is defined and p.yards >= 20 %}stat-good{% elif p.yards is defined and p.yards < 0 %}stat-bad{% endif %}">{{ p.yards if p.yards is defined else '—' }}</td>
    <td class="num {% if p.epa is defined and p.epa > 2 %}stat-good{% elif p.epa is defined and p.epa < -2 %}stat-bad{% endif %}">{{ '%.1f'|format(p.epa) if p.epa is defined and p.epa is not none else '—' }}</td>
    <td style="white-space:normal;max-width:400px;{% if is_score %}color:var(--yellow);font-weight:bold{% elif is_turnover %}color:var(--red){% endif %}">{{ p.description if p.description else '—' }}</td>
  </tr>
  {% endfor %}
  </tbody>
</table>
{% endif %}

{% else %}
<div class="empty">Detailed match data not available for this game.</div>
{% endif %}

{% endblock %}
