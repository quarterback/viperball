{% extends "base.html" %}
{% block title %}{{ team_name }} — Viperball Stats{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb"><div class="container wide">
  <a href="/stats/">Home</a><span class="sep">/</span><a href="/stats/college/">College</a><span class="sep">/</span><a href="/stats/college/{{ session_id }}/">Season</a><span class="sep">/</span>{{ team_name }}
</div></div>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1>{{ team.name }} {{ team.mascot }}</h1>
  <div class="subtitle">
    {{ team.abbreviation }}
    {% if record %} &middot; <span class="record"><span class="w">{{ record.wins }}</span>-<span class="l">{{ record.losses }}</span></span> ({{ record.conference }}){% endif %}
    {% if prestige %} &middot; Prestige: {{ prestige }}{% endif %}
  </div>
</div>

{% if record %}
{# ── Team Metrics ── #}
<div class="grid-4" style="margin-bottom: 16px;">
  <div class="metric">
    <div class="label">Record</div>
    <div class="value"><span class="w">{{ record.wins }}</span>-<span class="l">{{ record.losses }}</span></div>
  </div>
  <div class="metric">
    <div class="label">Points Per Drive</div>
    <div class="value accent">{{ record.avg_ppd }}</div>
  </div>
  <div class="metric">
    <div class="label">Team Rating</div>
    <div class="value">{{ record.avg_team_rating }}</div>
  </div>
  <div class="metric">
    <div class="label">TO Margin</div>
    <div class="value {% if record.avg_to_margin > 0 %}stat-good{% elif record.avg_to_margin < 0 %}stat-bad{% endif %}">{{ "%+.1f"|format(record.avg_to_margin) }}</div>
  </div>
</div>

<div class="grid-4" style="margin-bottom: 16px;">
  <div class="metric">
    <div class="label">Points For</div>
    <div class="value">{{ record.points_for }}</div>
  </div>
  <div class="metric">
    <div class="label">Points Against</div>
    <div class="value">{{ record.points_against }}</div>
  </div>
  <div class="metric">
    <div class="label">Conversion %</div>
    <div class="value">{{ record.avg_conversion_pct }}%</div>
  </div>
  <div class="metric">
    <div class="label">Lateral %</div>
    <div class="value">{{ record.avg_lateral_pct }}%</div>
  </div>
</div>
{% endif %}

{% if team_stats %}
{# ── Season Stats ── #}
<h2 style="margin-top:24px; margin-bottom:12px;">Season Stats <span style="color:var(--fg-dim); font-size:0.7em;">({{ team_stats.games_played }} games)</span></h2>

{# ── Offense ── #}
<h3 style="margin-bottom:8px; color:var(--accent);">Offense</h3>
<table style="margin-bottom:16px;">
  <thead>
    <tr><th>Category</th><th class="num">Total</th><th class="num">Per Game</th><th class="num">Detail</th></tr>
  </thead>
  <tbody>
    <tr>
      <td>Total Yards</td>
      <td class="num">{{ team_stats.total_yards }}</td>
      <td class="num">{{ team_stats.avg_yards }}</td>
      <td class="num">&mdash;</td>
    </tr>
    <tr>
      <td>Rushing</td>
      <td class="num">{{ team_stats.rushing_yards }} yds</td>
      <td class="num">{{ team_stats.avg_rushing }} yds</td>
      <td class="num">{{ team_stats.rushing_carries }} car &middot; {{ team_stats.rushing_tds }} TD &middot; {{ team_stats.yards_per_carry }} ypc</td>
    </tr>
    <tr>
      <td>Kick-Pass</td>
      <td class="num">{{ team_stats.kick_pass_yards }} yds</td>
      <td class="num">{{ "%.1f"|format(team_stats.kick_pass_yards / team_stats.games_played) }} yds</td>
      <td class="num">{{ team_stats.kp_completions }}/{{ team_stats.kp_attempts }} ({{ team_stats.kp_comp_pct }}%) &middot; {{ team_stats.kp_tds }} TD &middot; {{ team_stats.kp_ints }} INT</td>
    </tr>
    <tr>
      <td>Laterals</td>
      <td class="num">{{ team_stats.lateral_yards }} yds</td>
      <td class="num">{{ "%.1f"|format(team_stats.lateral_yards / team_stats.games_played) }} yds</td>
      <td class="num">{{ team_stats.lateral_chains }} chains</td>
    </tr>
    <tr>
      <td>Scoring</td>
      <td class="num">{{ team_stats.touchdowns }} TD</td>
      <td class="num">{{ "%.1f"|format(team_stats.touchdowns / team_stats.games_played) }} TD</td>
      <td class="num">DK {{ team_stats.dk_made }}/{{ team_stats.dk_att }} &middot; PK {{ team_stats.pk_made }}/{{ team_stats.pk_att }}</td>
    </tr>
  </tbody>
</table>

{# ── Efficiency ── #}
<h3 style="margin-bottom:8px; color:var(--accent);">Efficiency</h3>
<div class="grid-4" style="margin-bottom:16px;">
  {% if team_stats.avg_viper_eff is not none %}
  <div class="metric">
    <div class="label">Viper Efficiency</div>
    <div class="value accent">{{ team_stats.avg_viper_eff }}</div>
  </div>
  {% endif %}
  <div class="metric">
    <div class="label">EPA (Total)</div>
    <div class="value {% if team_stats.total_epa > 0 %}stat-good{% elif team_stats.total_epa < 0 %}stat-bad{% endif %}">{{ team_stats.total_epa }}</div>
  </div>
  <div class="metric">
    <div class="label">EPA / Game</div>
    <div class="value {% if team_stats.avg_epa > 0 %}stat-good{% elif team_stats.avg_epa < 0 %}stat-bad{% endif %}">{{ team_stats.avg_epa }}</div>
  </div>
  {% if team_stats.avg_team_rating is not none %}
  <div class="metric">
    <div class="label">Avg Team Rating</div>
    <div class="value">{{ team_stats.avg_team_rating }}</div>
  </div>
  {% endif %}
</div>

<table style="margin-bottom:16px;">
  <thead>
    <tr><th>Down</th><th class="num">Attempts</th><th class="num">Converted</th><th class="num">Rate</th></tr>
  </thead>
  <tbody>
    <tr>
      <td>4th Down</td>
      <td class="num">{{ team_stats.down_conv_4.att }}</td>
      <td class="num">{{ team_stats.down_conv_4.conv }}</td>
      <td class="num">{{ team_stats.down_conv_4.rate }}%</td>
    </tr>
    <tr>
      <td>5th Down</td>
      <td class="num">{{ team_stats.down_conv_5.att }}</td>
      <td class="num">{{ team_stats.down_conv_5.conv }}</td>
      <td class="num">{{ team_stats.down_conv_5.rate }}%</td>
    </tr>
    <tr>
      <td>6th Down</td>
      <td class="num">{{ team_stats.down_conv_6.att }}</td>
      <td class="num">{{ team_stats.down_conv_6.conv }}</td>
      <td class="num">{{ team_stats.down_conv_6.rate }}%</td>
    </tr>
  </tbody>
</table>

{# ── Other ── #}
<h3 style="margin-bottom:8px; color:var(--accent);">Other</h3>
<div class="grid-4" style="margin-bottom:24px;">
  <div class="metric">
    <div class="label">Fumbles Lost</div>
    <div class="value">{{ team_stats.fumbles }}</div>
  </div>
  <div class="metric">
    <div class="label">Turnovers on Downs</div>
    <div class="value">{{ team_stats.tod }}</div>
  </div>
  <div class="metric">
    <div class="label">Penalties</div>
    <div class="value">{{ team_stats.penalties }} ({{ team_stats.penalty_yards }} yds)</div>
  </div>
  <div class="metric">
    <div class="label">Delta Yards</div>
    <div class="value {% if team_stats.delta_yards > 0 %}stat-good{% elif team_stats.delta_yards < 0 %}stat-bad{% endif %}">{{ team_stats.delta_yards }}</div>
  </div>
</div>

<div class="grid-4" style="margin-bottom:24px;">
  <div class="metric">
    <div class="label">Bonus Possessions</div>
    <div class="value">{{ team_stats.bonus_possessions }}</div>
  </div>
  <div class="metric">
    <div class="label">Bonus Scores</div>
    <div class="value">{{ team_stats.bonus_scores }}</div>
  </div>
  <div class="metric">
    <div class="label">&nbsp;</div>
    <div class="value">&nbsp;</div>
  </div>
  <div class="metric">
    <div class="label">&nbsp;</div>
    <div class="value">&nbsp;</div>
  </div>
</div>
{% endif %}

<div class="grid-2">

{# ── Schedule ── #}
<div>
<h2>Schedule</h2>
<table>
  <thead>
    <tr><th class="num">Wk</th><th></th><th>Opponent</th><th>Result</th><th>Tags</th></tr>
  </thead>
  <tbody>
  {% for g in games %}
  {% set is_home = (g.home_team == team_name) %}
  {% set opponent = g.away_team if is_home else g.home_team %}
  {% set won = g.completed and ((is_home and g.home_score > g.away_score) or (not is_home and g.away_score > g.home_score)) %}
  <tr>
    <td class="num">{{ g.week }}</td>
    <td style="color:var(--fg-dim)">{{ 'vs' if is_home else '@' }}</td>
    <td><a href="/stats/college/{{ session_id }}/team/{{ opponent }}">{{ opponent }}</a></td>
    <td>
      {% if g.completed %}
      <span class="{% if won %}w{% else %}l{% endif %}" style="font-weight:bold">{{ 'W' if won else 'L' }}</span>
      {% if is_home %}{{ g.home_score }}-{{ g.away_score }}{% else %}{{ g.away_score }}-{{ g.home_score }}{% endif %}
      {% else %}
      <span style="color:var(--fg-dim)">&mdash;</span>
      {% endif %}
    </td>
    <td>
      {% if g.is_conference_game %}<span class="tag tag-conf">CONF</span>{% endif %}
      {% if g.is_rivalry_game %}<span class="tag tag-rivalry">RIV</span>{% endif %}
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>
</div>

{# ── Roster ── #}
<div>
<h2>Roster ({{ players|length }})</h2>
<table>
  <thead>
    <tr>
      <th class="num">#</th><th>Name</th><th>Pos</th><th>Yr</th>
      <th class="num">OVR</th><th class="num">SPD</th><th class="num">PWR</th>
      <th class="num">AGI</th><th class="num">KCK</th><th class="num">LAT</th>
    </tr>
  </thead>
  <tbody>
  {% for p in players|sort(attribute='overall', reverse=true) %}
  <tr>
    <td class="num">{{ p.number }}</td>
    <td><a href="/stats/college/{{ session_id }}/player/{{ team_name }}/{{ p.name }}">{{ p.name }}</a></td>
    <td><span class="tag tag-pos">{{ p.position }}</span></td>
    <td>{{ p.year_abbr }}</td>
    <td class="num {% if p.overall >= 85 %}stat-elite{% elif p.overall >= 70 %}stat-good{% endif %}">{{ p.overall }}</td>
    <td class="num">{{ p.speed }}</td>
    <td class="num">{{ p.power }}</td>
    <td class="num">{{ p.agility }}</td>
    <td class="num">{{ p.kicking }}</td>
    <td class="num">{{ p.lateral_skill }}</td>
  </tr>
  {% endfor %}
  </tbody>
</table>
</div>

</div>
{% endblock %}
