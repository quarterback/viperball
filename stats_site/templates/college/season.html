{% extends "base.html" %}
{% block title %}{{ season.name if season else 'Season' }} — Viperball Stats{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb"><div class="container wide">
  <a href="/stats/">Home</a><span class="sep">/</span><a href="/stats/college/">College</a><span class="sep">/</span>{{ season.name if season else 'Season' }}
</div></div>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1>{{ season.name if season else 'Season' }}{% if dynasty %} &middot; {{ dynasty.dynasty_name }} ({{ dynasty.current_year }}){% endif %}</h1>
  <div class="subtitle">
    {{ standings|length }} teams &middot; {{ games_played }}/{{ total_games }} games played &middot; Week {{ current_week }}/{{ total_weeks }}
    {% if champion %} &middot; <span class="stat-elite">Champion: {{ champion }}</span>{% endif %}
  </div>
  {% if champion %}
  <div style="margin-top: 8px;">
    <button onclick="archiveSeason()" id="archive-btn" style="background: var(--bg-alt); color: var(--accent); border: 1px solid var(--accent); padding: 4px 12px; font-family: inherit; font-size: 11px; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;">Archive This Season</button>
    <span id="archive-status" style="margin-left: 8px; font-size: 11px; color: var(--fg-dim);"></span>
  </div>
  <script>
  async function archiveSeason() {
    const btn = document.getElementById('archive-btn');
    const status = document.getElementById('archive-status');
    btn.disabled = true;
    status.textContent = 'Archiving...';
    try {
      const resp = await fetch('/archives/college/{{ session_id }}', { method: 'POST' });
      const data = await resp.json();
      if (resp.ok) {
        status.style.color = 'var(--green)';
        status.textContent = 'Archived! View in Archives tab.';
        btn.textContent = 'Archived';
      } else {
        status.style.color = 'var(--red)';
        status.textContent = data.detail || 'Archive failed';
        btn.disabled = false;
      }
    } catch (e) {
      status.style.color = 'var(--red)';
      status.textContent = 'Network error';
      btn.disabled = false;
    }
  }
  </script>
  {% endif %}
</div>

<div class="tabs">
  <a href="/stats/college/{{ session_id }}/" class="active">Overview</a>
  <a href="/stats/college/{{ session_id }}/standings">Standings</a>
  <a href="/stats/college/{{ session_id }}/schedule">Schedule</a>
  <a href="/stats/college/{{ session_id }}/polls">Polls</a>
  <a href="/stats/college/{{ session_id }}/players">Players</a>
  <a href="/stats/college/{{ session_id }}/team-stats">Team Stats</a>
  <a href="/stats/college/{{ session_id }}/playoffs">Playoffs</a>
  <a href="/stats/college/{{ session_id }}/awards">Awards</a>
</div>

<div class="grid-2">

  {# ── Rankings snapshot ── #}
  <div>
    {% if latest_poll %}
    <h2>Latest Poll (Week {{ latest_poll.week }})</h2>
    <table>
      <thead>
        <tr><th class="num">#</th><th>Team</th><th>Record</th><th>Conf</th><th class="num">PWR</th><th class="num">+/-</th></tr>
      </thead>
      <tbody>
      {% for r in latest_poll.rankings[:25] %}
      <tr>
        <td class="num rank">{{ r.rank }}</td>
        <td><a href="/stats/college/{{ session_id }}/team/{{ r.team_name }}">{{ r.team_name }}</a></td>
        <td class="record">{{ r.record }}</td>
        <td>{{ r.conference[:12] }}</td>
        <td class="num">{{ "%.1f"|format(r.power_index) if r.power_index else '—' }}</td>
        <td class="num {% if r.rank_change and r.rank_change > 0 %}change-up{% elif r.rank_change and r.rank_change < 0 %}change-down{% else %}change-none{% endif %}">
          {% if r.rank_change and r.rank_change > 0 %}+{{ r.rank_change }}{% elif r.rank_change and r.rank_change < 0 %}{{ r.rank_change }}{% else %}—{% endif %}
        </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
    <div style="margin-top: 4px; font-size: 11px;"><a href="/stats/college/{{ session_id }}/polls">Full poll &rarr;</a></div>
    {% else %}
    <h2>Rankings</h2>
    <p class="empty">No polls generated yet.</p>
    {% endif %}
  </div>

  {# ── Top standings ── #}
  <div>
    <h2>Standings (Top 25)</h2>
    <table>
      <thead>
        <tr><th class="num">#</th><th>Team</th><th>W-L</th><th class="num">PF</th><th class="num">PA</th><th class="num">PPD</th><th class="num">Rating</th></tr>
      </thead>
      <tbody>
      {% for s in standings[:25] %}
      <tr>
        <td class="num rank">{{ loop.index }}</td>
        <td><a href="/stats/college/{{ session_id }}/team/{{ s.team_name }}">{{ s.team_name }}</a></td>
        <td class="record"><span class="w">{{ s.wins }}</span>-<span class="l">{{ s.losses }}</span></td>
        <td class="num">{{ s.points_for }}</td>
        <td class="num">{{ s.points_against }}</td>
        <td class="num">{{ s.avg_ppd }}</td>
        <td class="num {% if s.avg_team_rating >= 80 %}stat-elite{% elif s.avg_team_rating >= 60 %}stat-good{% endif %}">{{ s.avg_team_rating }}</td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
    <div style="margin-top: 4px; font-size: 11px;"><a href="/stats/college/{{ session_id }}/standings">Full standings &rarr;</a></div>
  </div>

</div>
{% endblock %}
